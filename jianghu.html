<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI江湖</title>
  <style>
    html, body { height: 100%; margin: 0; background: #0b0e14; color: #e6edf6; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif; }
    #chart { position: fixed; inset: 0; }
    .topbar { position: fixed; top: 14px; left: 14px; z-index: 10; display: flex; gap: 10px; align-items: center; }
    .btn { text-decoration: none; color: #e6edf6; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); padding: 10px 12px; border-radius: 10px; backdrop-filter: blur(10px); }
    .title { font-weight: 600; letter-spacing: .06em; opacity: .9; }
    .msg { position: fixed; right: 14px; top: 14px; z-index: 10; max-width: min(520px, calc(100vw - 28px)); white-space: pre-line; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.18); background: rgba(0,0,0,.35); backdrop-filter: blur(10px); font-size: 12px; line-height: 1.5; color: rgba(230,237,246,.9); }
    .modal { position: fixed; inset: 0; z-index: 20; display: none; align-items: center; justify-content: center; padding: 18px; background: rgba(0,0,0,.55); backdrop-filter: blur(6px); }
    .modal.active { display: flex; }
    .card { width: min(920px, 100%); border: 1px solid rgba(255,255,255,.18); background: rgba(15,18,26,.92); border-radius: 14px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,.45); }
    .card-hd { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,.10); }
    .card-title { font-weight: 600; opacity: .95; }
    .card-close { cursor: pointer; user-select: none; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); color: #e6edf6; padding: 6px 10px; border-radius: 10px; }
    .card-bd { padding: 12px 14px 14px; }
    .card-bd img { width: 100%; height: auto; display: block; border-radius: 12px; border: 1px solid rgba(255,255,255,.10); }
    .card-note { margin-top: 10px; font-size: 12px; opacity: .75; white-space: pre-line; }
  </style>
</head>
<body>
  <div class="topbar">
    <a class="btn" href="index.html">← 返回</a>
    <a class="btn" href="#" id="upBtn" style="display:none">↑ 上一级</a>
    <div class="title">AI江湖</div>
  </div>
  <div class="msg" id="msg">加载中…</div>
  <div id="chart" aria-label="中国地图"></div>
  <div class="modal" id="photoModal" aria-hidden="true">
    <div class="card" role="dialog" aria-label="城市风景照片">
      <div class="card-hd">
        <div class="card-title" id="photoTitle">城市</div>
        <button class="card-close" id="photoClose">关闭</button>
      </div>
      <div class="card-bd">
        <img id="photoImg" alt="" />
        <div class="card-note" id="photoNote"></div>
      </div>
    </div>
  </div>

  <script>
    (async () => {
      const msg = document.getElementById('msg');
      const setMsg = (t) => { if (msg) msg.textContent = t; };
      const upBtn = document.getElementById('upBtn');
      const photoModal = document.getElementById('photoModal');
      const photoClose = document.getElementById('photoClose');
      const photoTitle = document.getElementById('photoTitle');
      const photoImg = document.getElementById('photoImg');
      const photoNote = document.getElementById('photoNote');
      const loadScript = (src) => new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src; s.async = true;
        s.onload = resolve; s.onerror = () => reject(new Error('load fail: ' + src));
        document.head.appendChild(s);
      });

      setMsg('加载 ECharts…');
      for (const src of [
        'https://cdn.bootcdn.net/ajax/libs/echarts/5.5.0/echarts.min.js',
        'https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js',
        'https://unpkg.com/echarts@5/dist/echarts.min.js'
      ]) {
        try { await loadScript(src); if (window.echarts) break; } catch (e) {}
      }
      if (!window.echarts) {
        setMsg('ECharts 加载失败。\n可能是 CDN 被拦截。\n建议：换网络/开代理，或部署到 Vercel 后访问。');
        return;
      }

      const chart = echarts.init(document.getElementById('chart'));
      const cache = new Map(); // adcode -> geojson
      const stack = []; // [{ adcode, name }]
      const normCity = (n) => String(n || '').replace(/(市|地区|盟|自治州|特别行政区)$/,'');
      const cityPhotos = {
        '嘉兴': { title: '嘉兴｜香海禅寺·图书馆', src: 'AI+X_history_data/xianghaichansi-library-jiaxing.jpg', note: '把照片文件放到上述路径即可显示。' }
      };
      const closePhoto = () => { if (!photoModal) return; photoModal.classList.remove('active'); photoModal.setAttribute('aria-hidden', 'true'); };
      const openPhoto = (cityName) => {
        const key = cityPhotos[cityName] ? cityName : normCity(cityName);
        const item = cityPhotos[key];
        if (!photoModal || !photoImg || !photoTitle || !photoNote) return;
        if (!item) {
          photoTitle.textContent = `${cityName}`;
          photoImg.removeAttribute('src');
          photoImg.alt = '';
          photoNote.textContent = '暂无该市照片（可在代码里 cityPhotos 增加映射）。';
          photoModal.classList.add('active');
          photoModal.setAttribute('aria-hidden', 'false');
          return;
        }
        photoTitle.textContent = item.title || cityName;
        photoImg.alt = item.title || cityName;
        photoImg.src = item.src;
        photoImg.onerror = () => { photoNote.textContent = `图片加载失败：${item.src}\n请确认文件存在，或换成可访问的 URL。`; };
        photoNote.textContent = item.note || '';
        photoModal.classList.add('active');
        photoModal.setAttribute('aria-hidden', 'false');
      };
      if (photoClose) photoClose.addEventListener('click', closePhoto);
      if (photoModal) photoModal.addEventListener('click', (e) => { if (e.target === photoModal) closePhoto(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePhoto(); });

      const fetchGeoJSON = async (adcode) => {
        if (cache.has(adcode)) return cache.get(adcode);
        let geojson = null;
        for (const url of [
          `https://geo.datav.aliyun.com/areas_v3/bound/${adcode}_full.json`,
          `https://geo.datav.aliyun.com/areas_v3/bound/${adcode}.json`
        ]) {
          try { geojson = await (await fetch(url, { cache: 'force-cache' })).json(); break; } catch (e) {}
        }
        if (geojson) cache.set(adcode, geojson);
        return geojson;
      };

      const render = async (adcode, name) => {
        setMsg(`加载地图：${name || adcode}…`);
        const geojson = await fetchGeoJSON(adcode);
        if (!geojson) {
          setMsg('地图数据加载失败。\n如果你是用 file:// 直接打开，浏览器可能会拦截网络请求。\n建议：用本项目的启动脚本起一个本地 http 服务再打开。');
          return;
        }

        const mapName = `map_${adcode}`;
        echarts.registerMap(mapName, geojson);
        const data = (geojson.features || []).map(f => ({
          name: f?.properties?.name,
          adcode: String(f?.properties?.adcode || '')
        })).filter(d => d.name && d.adcode);

        chart.setOption({
          tooltip: { trigger: 'item' },
          series: [{
            type: 'map',
            map: mapName,
            roam: true,
            zoom: 1.05,
            label: { show: false },
            itemStyle: { areaColor: '#1b2433', borderColor: '#6aa7ff', borderWidth: 0.8 },
            emphasis: { label: { show: false }, itemStyle: { areaColor: '#2b6cff' } },
            data
          }]
        }, true);

        if (upBtn) upBtn.style.display = stack.length ? '' : 'none';
        setMsg(stack.length ? `当前位置：${stack.map(x => x.name).join(' / ')}\n提示：点击下钻；拖拽移动，滚轮缩放。` : '提示：点击省下钻到市；拖拽移动，滚轮缩放。');
      };

      chart.on('click', async (params) => {
        const nextAdcode = params?.data?.adcode;
        const nextName = params?.name;
        if (!nextAdcode || !nextName) return;
        if (stack.length === 0) { // 中国 -> 省（进入市级边界）
          stack.push({ adcode: nextAdcode, name: nextName });
          await render(nextAdcode, nextName);
          return;
        }
        // 已经在“市级边界”视图：点击市只做提示/高亮，不再下钻到区县
        setMsg(`当前位置：${stack.map(x => x.name).join(' / ')}\n已选择：${nextName}\n提示：拖拽移动，滚轮缩放。`);
        chart.dispatchAction({ type: 'downplay' });
        chart.dispatchAction({ type: 'highlight', seriesIndex: 0, name: nextName });
        openPhoto(nextName);
      });

      if (upBtn) upBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        stack.pop();
        const cur = stack[stack.length - 1];
        await render(cur ? cur.adcode : '100000', cur ? cur.name : '中国');
      });

      await render('100000', '中国');
      window.addEventListener('resize', () => chart.resize());
    })();
  </script>
</body>
</html>
