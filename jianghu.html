<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI江湖</title>
  <style>
    html, body { height: 100%; margin: 0; background: #0b0e14; color: #e6edf6; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,sans-serif; }
    #chart { position: fixed; inset: 0; }
    .topbar { position: fixed; top: 14px; left: 14px; z-index: 10; display: flex; gap: 10px; align-items: center; }
    .btn { text-decoration: none; color: #e6edf6; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); padding: 10px 12px; border-radius: 10px; backdrop-filter: blur(10px); }
    .title { font-weight: 600; letter-spacing: .06em; opacity: .9; }
    .msg { position: fixed; right: 14px; top: 14px; z-index: 10; max-width: min(520px, calc(100vw - 28px)); white-space: pre-line; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.18); background: rgba(0,0,0,.35); backdrop-filter: blur(10px); font-size: 12px; line-height: 1.5; color: rgba(230,237,246,.9); }
    .modal { position: fixed; inset: 0; z-index: 20; display: none; align-items: center; justify-content: center; padding: 18px; background: rgba(0,0,0,.55); backdrop-filter: blur(6px); }
    .modal.active { display: flex; }
    .card { width: min(920px, 100%); border: 1px solid rgba(255,255,255,.18); background: rgba(15,18,26,.92); border-radius: 14px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,.45); }
    .card-hd { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,.10); }
    .card-title { font-weight: 600; opacity: .95; }
    .card-close { cursor: pointer; user-select: none; border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); color: #e6edf6; padding: 6px 10px; border-radius: 10px; }
    .card-bd { padding: 12px 14px 14px; }
    .photo-frame { position: relative; border-radius: 12px; border: 1px solid rgba(255,255,255,.10); overflow: hidden; background: rgba(7,10,16,.6); }
    .photo-frame.is-loading::after {
      content: "加载中…";
      position: absolute; inset: 0;
      display: grid; place-items: center;
      color: rgba(230,237,246,.85);
      font-size: 12px; letter-spacing: .06em;
      background: rgba(8,10,16,.35);
      pointer-events: none;
    }
    .photo-frame img {
      width: 100%; height: auto; display: block;
      opacity: 1; transition: opacity .22s ease;
    }
    .photo-nav {
      position: absolute; top: 50%; transform: translateY(-50%);
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(12,16,24,.65);
      color: #e6edf6; padding: 8px 10px;
      border-radius: 999px; cursor: pointer;
      backdrop-filter: blur(6px);
    }
    .photo-nav[disabled] { opacity: .35; cursor: not-allowed; }
    .photo-nav.prev { left: 10px; }
    .photo-nav.next { right: 10px; }
    .photo-counter {
      position: absolute; right: 12px; bottom: 10px;
      font-size: 12px; padding: 4px 8px;
      border-radius: 999px; background: rgba(12,16,24,.65);
      border: 1px solid rgba(255,255,255,.15);
    }
    .photo-dots {
      position: absolute; left: 12px; bottom: 10px;
      display: flex; gap: 6px; align-items: center;
    }
    .photo-dot {
      width: 8px; height: 8px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.4);
      background: rgba(255,255,255,.18);
      cursor: pointer; padding: 0;
    }
    .photo-dot.active { background: #6aa7ff; border-color: #6aa7ff; }
    .card-note { margin-top: 10px; font-size: 12px; opacity: .75; white-space: pre-line; }
  </style>
</head>
<body>
  <div class="topbar">
    <a class="btn" href="index.html">← 返回</a>
    <a class="btn" href="#" id="upBtn" style="display:none">↑ 上一级</a>
    <div class="title">AI江湖</div>
  </div>
  <div class="msg" id="msg">加载中…</div>
  <div id="chart" aria-label="中国地图"></div>
  <div class="modal" id="photoModal" aria-hidden="true">
    <div class="card" role="dialog" aria-label="城市风景照片">
      <div class="card-hd">
        <div class="card-title" id="photoTitle">城市</div>
        <button class="card-close" id="photoClose">关闭</button>
      </div>
      <div class="card-bd">
        <div class="photo-frame" id="photoFrame">
          <img id="photoImg" alt="" />
          <button class="photo-nav prev" id="photoPrev" aria-label="上一张">‹</button>
          <button class="photo-nav next" id="photoNext" aria-label="下一张">›</button>
          <div class="photo-counter" id="photoCounter"></div>
          <div class="photo-dots" id="photoDots" aria-label="图片序列"></div>
        </div>
        <div class="card-note" id="photoNote"></div>
      </div>
    </div>
  </div>

  <script>
    (async () => {
      const msg = document.getElementById('msg');
      const setMsg = (t) => { if (msg) msg.textContent = t; };
      const upBtn = document.getElementById('upBtn');
      const photoModal = document.getElementById('photoModal');
      const photoClose = document.getElementById('photoClose');
      const photoTitle = document.getElementById('photoTitle');
      const photoImg = document.getElementById('photoImg');
      const photoNote = document.getElementById('photoNote');
      const photoFrame = document.getElementById('photoFrame');
      const photoPrev = document.getElementById('photoPrev');
      const photoNext = document.getElementById('photoNext');
      const photoCounter = document.getElementById('photoCounter');
      const photoDots = document.getElementById('photoDots');
      const loadScript = (src) => new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src; s.async = true;
        s.onload = resolve; s.onerror = () => reject(new Error('load fail: ' + src));
        document.head.appendChild(s);
      });

      setMsg('加载 ECharts…');
      for (const src of [
        'https://cdn.bootcdn.net/ajax/libs/echarts/5.5.0/echarts.min.js',
        'https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js',
        'https://unpkg.com/echarts@5/dist/echarts.min.js'
      ]) {
        try { await loadScript(src); if (window.echarts) break; } catch (e) {}
      }
      if (!window.echarts) {
        setMsg('ECharts 加载失败。\n可能是 CDN 被拦截。\n建议：换网络/开代理，或部署到 Vercel 后访问。');
        return;
      }

      const chart = echarts.init(document.getElementById('chart'));
      const cache = new Map(); // adcode -> geojson
      const stack = []; // [{ adcode, name }]
      const normCity = (n) => String(n || '').trim().replace(/\s+/g,'').replace(/[（(].*?[）)]/g,'').replace(/(市|地区|盟|自治州|特别行政区)$/,'');
      let cityPhotos = null; // { 城市: { title, note, photos:[{src,title}] } }
      let curPhotos = []; let curIdx = 0;
      let curModalTitle = ''; let curNoteBase = '';
      let cityPhotosPromise = null;
      let cityPhotosError = '';
      let pendingCityName = '';
      let switchToken = 0;
      const closePhoto = () => { if (!photoModal) return; photoModal.classList.remove('active'); photoModal.setAttribute('aria-hidden', 'true'); };
      const joinNote = (extra) => {
        if (!extra) return curNoteBase || '';
        if (!curNoteBase) return extra;
        return curNoteBase.endsWith('\n') ? curNoteBase + extra : `${curNoteBase}\n${extra}`;
      };
      const showPhoto = (title, src, note) => {
        if (!photoModal || !photoImg || !photoTitle || !photoNote) return;
        photoTitle.textContent = title || '';
        photoImg.alt = title || '';
        photoImg.onerror = null;
        if (!src) {
          photoImg.style.display = 'none';
          photoImg.removeAttribute('src');
        } else {
          photoImg.style.display = 'block';
          photoImg.src = src;
          photoImg.onerror = async () => {
            let extra = '';
            try {
              const r = await fetch(src, { cache: 'no-store' });
              const t = await r.text();
              extra = `\nHTTP ${r.status}\n${t.slice(0, 400)}`;
            } catch (e) {
              extra = `\n${String(e?.message || e)}`;
            }
            photoNote.textContent = `图片加载失败：${src}${extra}`;
          };
        }
        photoNote.textContent = note || '';
        photoModal.classList.add('active');
        photoModal.setAttribute('aria-hidden', 'false');
      };
      const preloadImage = (src) => new Promise((resolve, reject) => {
        if (!src) return resolve(null);
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
      const updateIndicators = () => {
        const multi = curPhotos.length > 1;
        if (photoPrev) { photoPrev.disabled = !multi; photoPrev.style.display = multi ? '' : 'none'; }
        if (photoNext) { photoNext.disabled = !multi; photoNext.style.display = multi ? '' : 'none'; }
        if (photoCounter) {
          photoCounter.textContent = curPhotos.length ? `${curIdx + 1}/${curPhotos.length}` : '';
          photoCounter.style.display = curPhotos.length ? '' : 'none';
        }
        if (photoDots) {
          photoDots.innerHTML = '';
          if (!multi) { photoDots.style.display = 'none'; return; }
          photoDots.style.display = '';
          curPhotos.forEach((_, i) => {
            const dot = document.createElement('button');
            dot.type = 'button';
            dot.className = `photo-dot${i === curIdx ? ' active' : ''}`;
            dot.setAttribute('aria-label', `第 ${i + 1} 张`);
            dot.addEventListener('click', () => setPhoto(i));
            photoDots.appendChild(dot);
          });
        }
      };
      const buildNote = (photo) => {
        if (curPhotos.length > 1) {
          return joinNote(`共 ${curPhotos.length} 张 · ${curIdx + 1}/${curPhotos.length}（左右按钮/键盘/点点切换）`);
        }
        return joinNote(photo?.title || '');
      };
      const setPhoto = async (nextIdx) => {
        if (!curPhotos?.length) return;
        const token = ++switchToken;
        curIdx = (nextIdx + curPhotos.length) % curPhotos.length;
        const p = curPhotos[curIdx];
        updateIndicators();
        if (photoFrame) photoFrame.classList.add('is-loading');
        try { await preloadImage(p?.src); } catch (e) {}
        if (token !== switchToken) return;
        if (!photoImg) return;
        const note = buildNote(p);
        photoImg.style.opacity = '0';
        const finalize = () => {
          if (token !== switchToken) return;
          showPhoto(curModalTitle, p?.src, note);
          requestAnimationFrame(() => {
            if (photoImg) photoImg.style.opacity = '1';
            if (photoFrame) photoFrame.classList.remove('is-loading');
          });
        };
        photoImg.addEventListener('transitionend', finalize, { once: true });
        setTimeout(finalize, 220);
      };
      const loadCityPhotos = async () => {
        if (cityPhotos || cityPhotosError) return cityPhotos;
        if (cityPhotosPromise) return cityPhotosPromise;
        cityPhotosPromise = (async () => {
          try {
            const r = await fetch('/api/city-photos', { cache: 'no-store' });
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            cityPhotos = await r.json();
            return cityPhotos;
          } catch (e) {
            cityPhotosError = String(e?.message || e);
            return null;
          } finally {
            cityPhotosPromise = null;
          }
        })();
        return cityPhotosPromise;
      };
      const openPhoto = (cityName) => {
        if (!cityPhotos) {
          pendingCityName = cityName;
          showPhoto(cityName, '', '照片库加载中…');
          loadCityPhotos().then(() => {
            const c = pendingCityName; pendingCityName = '';
            if (!c) return;
            if (cityPhotos) openPhoto(c);
            else showPhoto(c, '', `照片库加载失败：${cityPhotosError || 'unknown'}\n请检查 /api/city-photos 是否能打开。`);
          });
          return;
        }
        const key = cityPhotos[cityName] ? cityName : normCity(cityName);
        const item = cityPhotos[key];
        if (!item?.photos?.length) return showPhoto(cityName, '', `暂无该市照片。\n把图片放到：AI+X_history_data/地图/${key}/ 里即可自动出现。`);
        curPhotos = item.photos; curIdx = 0;
        curModalTitle = item.title || cityName;
        curNoteBase = (item.note ? item.note + '\n' : '');
        setPhoto(0);
      };
      if (photoImg) photoImg.addEventListener('click', () => {
        if (!curPhotos?.length) return;
        setPhoto(curIdx + 1);
      });
      if (photoPrev) photoPrev.addEventListener('click', () => setPhoto(curIdx - 1));
      if (photoNext) photoNext.addEventListener('click', () => setPhoto(curIdx + 1));
      if (photoClose) photoClose.addEventListener('click', closePhoto);
      if (photoModal) photoModal.addEventListener('click', (e) => { if (e.target === photoModal) closePhoto(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closePhoto();
        if (!photoModal || !photoModal.classList.contains('active')) return;
        if (e.key === 'ArrowRight') setPhoto(curIdx + 1);
        if (e.key === 'ArrowLeft') setPhoto(curIdx - 1);
      });
      loadCityPhotos();

      const fetchGeoJSON = async (adcode) => {
        if (cache.has(adcode)) return cache.get(adcode);
        let geojson = null;
        let lastErr = '';
        for (const url of [
          `/api/geo?adcode=${adcode}`,
          `https://geo.datav.aliyun.com/areas_v3/bound/${adcode}_full.json`,
          `https://geo.datav.aliyun.com/areas_v3/bound/${adcode}.json`
        ]) {
          try {
            const r = await fetch(url, { cache: 'force-cache' });
            if (!r.ok) { lastErr = `${r.status} ${url}`; continue; }
            geojson = await r.json();
            break;
          } catch (e) { lastErr = `${String(e?.message || e)} ${url}`; }
        }
        if (geojson) cache.set(adcode, geojson);
        if (!geojson && lastErr) setMsg(`地图数据加载失败：${lastErr}\n（若是 CORS/网络问题，已优先走 /api/geo 代理）`);
        return geojson;
      };

      const render = async (adcode, name) => {
        setMsg(`加载地图：${name || adcode}…`);
        const geojson = await fetchGeoJSON(adcode);
        if (!geojson) {
          setMsg('地图数据加载失败。\n如果你是用 file:// 直接打开，浏览器可能会拦截网络请求。\n建议：用本项目的启动脚本起一个本地 http 服务再打开。');
          return;
        }

        const mapName = `map_${adcode}`;
        echarts.registerMap(mapName, geojson);
        const data = (geojson.features || []).map(f => ({
          name: f?.properties?.name,
          adcode: String(f?.properties?.adcode || '')
        })).filter(d => d.name && d.adcode);

        chart.setOption({
          tooltip: { trigger: 'item' },
          series: [{
            type: 'map',
            map: mapName,
            roam: true,
            zoom: 1.05,
            label: { show: false },
            itemStyle: { areaColor: '#1b2433', borderColor: '#6aa7ff', borderWidth: 0.8 },
            emphasis: { label: { show: false }, itemStyle: { areaColor: '#2b6cff' } },
            data
          }]
        }, true);

        if (upBtn) upBtn.style.display = stack.length ? '' : 'none';
        setMsg(stack.length ? `当前位置：${stack.map(x => x.name).join(' / ')}\n提示：点击下钻；拖拽移动，滚轮缩放。` : '提示：点击省下钻到市；拖拽移动，滚轮缩放。');
      };

      chart.on('click', async (params) => {
        const nextAdcode = params?.data?.adcode;
        const nextName = params?.name;
        if (!nextAdcode || !nextName) return;
        if (stack.length === 0) { // 中国 -> 省（进入市级边界）
          stack.push({ adcode: nextAdcode, name: nextName });
          await render(nextAdcode, nextName);
          return;
        }
        // 已经在“市级边界”视图：点击市只做提示/高亮，不再下钻到区县
        setMsg(`当前位置：${stack.map(x => x.name).join(' / ')}\n已选择：${nextName}\n提示：拖拽移动，滚轮缩放。`);
        chart.dispatchAction({ type: 'downplay' });
        chart.dispatchAction({ type: 'highlight', seriesIndex: 0, name: nextName });
        openPhoto(nextName);
      });

      if (upBtn) upBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        stack.pop();
        const cur = stack[stack.length - 1];
        await render(cur ? cur.adcode : '100000', cur ? cur.name : '中国');
      });

      await render('100000', '中国');
      window.addEventListener('resize', () => chart.resize());
    })();
  </script>
</body>
</html>
